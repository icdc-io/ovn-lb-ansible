- hosts: ovirt_engine
  gather_facts: no
  vars:
    location: "{{ location_code | default(inventory_file | dirname | basename) }}"
    #lb_router: e.g. sys_default, without location code
    #lb_name:
    #lb_port:
    #lb_backends: []
    #lb_proto: tcp
    #primary_ip:
    # implement via 
    # LB name: account+name or account+proto+port
    # for LoadBalancer we remove location prefix
  tasks:
  - set_fact:
      ovn_lb_name: "{{ lb_router.split('_').0 }}_{{ lb_name | d( (lb_proto|d('tcp'))~'_'~lb_port ) }}"
      ovn_lb_router: "{{ location }}_{{ lb_router }}"
  - name: Configure OVN LoadBalancer
    shell: >
      ovn-nbctl --may-exist lb-add "{{ ovn_lb_name | regex_replace('[^a-z0-9_].*','') }}" "{{ primary_ip | regex_replace('[^a-f0-9:\.].*','') }}:{{ lb_port | regex_replace('[^0-9].*','') }}" "{{ lb_backends.split(' ').0 | regex_replace('[^a-f0-9:\.].*','') }}" "{{ lb_proto | d('tcp') | regex_replace('[^a-z0-9].*','') }}" &&
      ovn-nbctl --may-exist lr-lb-add "{{ ovn_lb_router | regex_replace('[^a-z0-9_].*','') }}" "{{ ovn_lb_name | regex_replace('[^a-z0-9_].*','') }}"
